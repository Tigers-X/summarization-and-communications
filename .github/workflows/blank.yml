name: sum+inter workflow
run-name: Summarizer and Interactor in GitHub Actions ðŸš€
on: [issue_comment]
jobs:
    issue_commented:
        name: Issue comment
        runs-on: ubuntu-latest
        steps:
            - name: Set up Node.js
              uses: actions/setup-node@v2
              with:
                node-version: '14'
    
            - name: Install dependencies
              run: npm install axios

            - name: Commenting on the issue
              id: comment
              uses: actions/github-script@v4
              with: 
                  script: |
                    const axios = require('axios');
                    const commentBody = context.payload.comment.body;
                    const prefix = 'TriagerX';
                    if (commentBody.startsWith(prefix)) {
                        let restCommentBody = commentBody.replace(prefix, '').trim();
                        let action = ''
                        let model = ''

                        if (commentBody.includes('/summarize')){
                          restCommentBody = restCommentBody.replace('/summarize', '').trim();
                          action = 'summarize'
                        } else if (commentBody.includes('/interact')){
                          restCommentBody = restCommentBody.replace('/interact', '').trim();
                          action = 'interact'
                        }

                        if (commentBody.includes('-chatgpt')){
                          restCommentBody = restCommentBody.replace('-chatgpt', '').trim();
                          model = 'chatgpt'
                        } else if (commentBody.includes('-gemini')){
                          restCommentBody = restCommentBody.replace('-gemini', '').trim();
                          model = 'gemini'
                        }
                        
                        input = {
                          "issueData": {},
                          "commentsData" : [],
                          "model" : model,
                          "action" : action,
                          "userComment" : restCommentBody
                        }

                        let issueUrl = "";
                        let issueNumber = "";
                        let issueOwner = "";
                        let issueRepo = "";

                        if (commentBody.includes('https')) {
                          // this is for summarization     example: TriagerX /summarize -chatgpt https://github.com/eclipse-openj9/openj9/issues/19576
                          issueUrl = restCommentBody.trim();
                          issueNumber = issueUrl.split('/').pop();
                          issueOwner = issueUrl.split('/')[3];
                          issueRepo = issueUrl.split('/')[4];
                        } else {
                          // this is for interaction       example: TriagerX /interact -gemini How are you?
                          issueUrl = context.event.issue;
                          issueNumber = context.issue.number;
                          issueOwner = context.repo.owner;
                          issueRepo = context.repo.repo;
                        }

                        const { data: issueData } = await github.issues.get({
                          issue_number: issueNumber,
                          owner: issueOwner,
                          repo: issueRepo
                        });

                        input['issueData'] = issueData;

                        if (action == 'interact') {
                          const commentsUrl = issueData.comments_url;
                          const { data: commentsData } = await github.request(commentsUrl);
                          input['commentsData'] = commentsData;
                        }

                        const apiUrl = 'https://our-api-url';
                        const response = await axios.post(apiUrl, JSON.stringify(input), {
                          headers: {
                            'Content-Type': 'application/json'
                          }
                        });
                        
                        let newCommentBody = response.data['response'];
                        console.log('newCommentBody: ', newCommentBody)
                        
                        await github.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: newCommentBody
                        });
                      }
                    }
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
